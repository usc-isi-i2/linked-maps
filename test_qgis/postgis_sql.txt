 st_asgeojson
 postico


 select st_asText(st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005))) from test_line as a join altered as b on st_intersects(a.geom, b.geom);

# usgs and rail
select st_asText(st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005))) from usgs_trans as a join clip_rail13 as b on st_intersects(a.geom, b.geom);

# output
pgsql2shp -f ~/Desktop/DTIN/ISI/intersections -h localhost -u postgres test_gis "SELECT st_intersection(st_buffer(a.geom, 0.0001), st_buffer(b.geom, 0.0001)) as geom FROM usgs_trans AS a JOIN clip_rail13 AS b ON st_dwithin(a.geom, b.geom, 0.0001);"

SELECT st_asgeojson(st_intersection(st_buffer(a.geom, 0.0001), st_buffer(b.geom, 0.0001))) FROM usgs_trans AS a JOIN clip_rail13 AS b ON st_dwithin(a.geom, b.geom, 0.0001);


# this works
create table test_intersections as SELECT st_collect(st_intersection(st_buffer(a.geom, 0.0001)::geometry(Polygon, 4269), st_buffer(b.geom, 0.0001)::geometry(Polygon, 4269))) as geom FROM usgs_trans AS a JOIN clip_rail13 AS b ON st_dwithin(a.geom, b.geom, 0.0001);

create table a_inter as select st_intersection(a.geom, b.geom) as geom from usgs_trans as a join test_intersections as b on st_intersects(a.geom, b.geom);

# new intersections using st_union, 03/13

create table a_inter as select st_intersection(a.geom, b.geom) as geom from usgs_trans as a, lateral (select st_union(test_intersections.geom) as geom from test_intersections where st_intersects(a.geom, test_intersections.geom)) as b;

# find st_difference methods to get the rest

# brute force, only one row output
select st_difference(a.all_geom, b.all_geom) from (select st_collect(geom) as all_geom from usgs_trans) as a, (select st_collect(geom) as all_geom from a_inter) as b;

# using st_dump and its geom to extract linestrings from multi
# https://www.bostongis.com/postgis_dump.snippet

select (st_dump(st_difference(a.all_geom, b.all_geom))).geom from (select st_collect(geom) as all_geom from usgs_trans) as a, (select st_collect(geom) as all_geom from a_inter) as b;
create table a_diff as select st_difference(a.geom, b.geom) as geom from usgs_trans as a, lateral (select st_union(test_intersections.geom) as geom from test_intersections where st_intersects(a.geom, test_intersections.geom)) as b;

# evaluation of segmentation: overlaps + diff = original

pgsql2shp -f ~/Desktop/DTIN/ISI/buffer -h localhost -u postgres test_gis "SELECT st_buffer(a.geom, 0.0001) as geom FROM usgs_trans AS a;"

create table a_buffer as SELECT st_buffer(a.geom, 0.0001)::geometry(Polygon, 4269) as geom FROM usgs_trans AS a;

   POLYGON((-105.184259254311 39.9394298456013,-105.184180045137 39.9393883285207,-105.184105468107 39.9393287625528,-105.18404356854 39.9392561107707,-105.183996602015 39.9391730205583,-105.183473952391 39.9379991430324,-105.184603360829 39.938489670167,-105.212027484885 39.9439348011492,-105.212121291283 39.9439632215581,-105.212207750669 39.9440093965971,-105.21228354046 39.9440715517852,-105.212345748096 39.9441472985335,-105.212391982971 39.944233725937,-105.212420468307 39.9443275126389,-105.212430109427 39.9444250544689,-105.212420535828 39.9445226029492,-105.21239211542 39.9446164093464,-105.212345940381 39.9447028687333,-105.212283785192 39.9447786585241,-105.212208038444 39.9448408661596,-105.212121611041 39.9448871010353,-105.212027824339 39.9449155863709,-105.211930282509 39.9449252274908,-105.211832734028 39.9449156538923,-105.184355998495 39.9394600767649,-105.184259254311 39.9394298456013))
 MULTIPOLYGON(((-105.140772396222 39.9433213869171,-105.135754358322 39.941963746399,-105.130985095616 39.941043561359,-105.126216081209 39.9415508974074,-105.125137812133 39.94174787128,-105.120631937095 39.9419677554267,-105.120518289626 39.9419603148135,-105.120409274232 39.9419273488668,-105.120310547115 39.9418705680063,-105.11974169543 39.9414504978326,-105.120471844541 39.9415836832014,-105.125023091893 39.9407522795784,-105.131116800443 39.9404549100568,-105.131235874785 39.9404633664637,-105.140997987036 39.9423464680732,-105.143629655206 39.9430584713322,-105.158688312915 39.943063334377,-105.158775291509 39.9430719293831,-105.158783080637 39.9431366136244,-105.158775588771 39.9432343440277,-105.158749174603 39.9433287349783,-105.158704853215 39.9434161590846,-105.158644327853 39.9434932566875,-105.158569924473 39.9435570649691,-105.158484502355 39.9436051318132,-105.158391344223 39.9436356100377,-105.158294030091 39.9436473283817,-105.144114210371 39.943954595104,-105.144008674639 39.9439456617603,-105.140772396222 39.9433213869171)),((-105.091801823033 39.9374076888428,-105.088361376721 39.9350188242248,-105.084890179711 39.9333701887828,-105.084806189289 39.9333196618703,-105.084733670032 39.9332537200999,-105.084675408813 39.9331748975768,-105.084633644578 39.9330862234063,-105.084609982304 39.9329911052873,-105.084605331318 39.9328931985555,-105.084619870356 39.9327962657118,-105.084653040689 39.932704031831,-105.084703567602 39.9326200414094,-105.084769509372 39.9325475221519,-105.084781364938 39.9325387591783,-105.092323701688 39.9365526311189,-105.092824053263 39.9369000488854,-105.095782541927 39.9370014779682,-105.095824610269 39.9370047014248,-105.097579762314 39.9372139846684,-105.097692681027 39.937241026423,-105.09779631778 39.9372933840005,-105.098235715562 39.9375838928455,-105.097960616853 39.9377952365812,-105.097885426146 39.9378429958349,-105.097802954041 39.9378766550168,-105.097715818065 39.9378951458397,-105.097626783773 39.9378978814354,-105.092225915157 39.9375816835153,-105.092119957227 39.9375639176549,-105.092020240706 39.9375239261042,-105.091801823033 39.9374076888428)))

select st_astext(st_intersection(a.geom, st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005)))) from test_line as a join altered as b on st_intersects(a.geom, b.geom);

 LINESTRING(-105.211930109457 39.9444252275208,-105.184453373923 39.9389696503934,-105.184152482046 39.9382938435111)
 MULTILINESTRING((-105.158558857029 39.9435632925966,-105.143563132302 39.9435584498754,-105.135867163454 39.9414762896081,-105.131006477862 39.9405384653696,-105.126144609786 39.9410556793529,-105.121341223898 39.941933142633),(-105.097779462265 39.9378816401251,-105.097520561994 39.9377104676209,-105.095765409949 39.9375011843773,-105.092659799879 39.9373947113715,-105.088612894208 39.9345847533336,-105.085104688676 39.9329185407961))

 select st_astext(st_intersection(b.geom, st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005)))) from test_line as a join altered as b on st_intersects(a.geom, b.geom);

  LINESTRING(-105.211930109457 39.9444252275208,-105.184453373923 39.9389696503934,-105.183774844269 39.9386749499146)
 MULTILINESTRING((-105.158283197985 39.9431474457299,-105.144103378265 39.9434547124522,-105.131141171159 39.9409543157718,-105.121283863778 39.9414353467822),(-105.097794400559 39.9372924154151,-105.09765600661 39.9373987361402,-105.092255137994 39.93708253822,-105.08461653198 39.9330174338154))

 ST_Difference

 select st_asText(st_difference(a.geom, st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005)))) from test_line as a join altered as b on st_intersects(a.geom, b.geom);

 LINESTRING(-105.184152482046 39.9382938435111,-105.177365591402 39.9230504031063)
 MULTILINESTRING((-105.158688151445 39.943563334351,-105.158558857029 39.9435632925966),(-105.121341223898 39.941933142633,-105.120471910338 39.9420919453494,-105.110750888883 39.940318748875,-105.099409413674 39.9389592862143,-105.097779462265 39.9378816401251))

 select st_asText(st_difference(b.geom, st_intersection(st_buffer(a.geom, 0.0005), st_buffer(b.geom, 0.0005)))) from test_line as a join altered as b on st_intersects(a.geom, b.geom);

  LINESTRING(-105.183774844269 39.9386749499146,-105.169053170185 39.9322810003331)
 MULTILINESTRING((-105.121283863778 39.9414353467822,-105.120607566379 39.9414683497117,-105.111027626988 39.9343940157255,-105.099818670152 39.9357372765318,-105.097794400559 39.9372924154151),(-105.08461653198 39.9330174338154,-105.084429569772 39.9329179364865))